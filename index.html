<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outlook To-Do Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons as SVG components
        const CheckCircle2 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                <path d="m9 12 2 2 4-4"/>
            </svg>
        );

        const Circle = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
            </svg>
        );

        const Mail = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect width="20" height="16" x="2" y="4" rx="2"/>
                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
            </svg>
        );

        const Calendar = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                <line x1="16" x2="16" y1="2" y2="6"/>
                <line x1="8" x2="8" y1="2" y2="6"/>
                <line x1="3" x2="21" y1="10" y2="10"/>
            </svg>
        );

        const Tag = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/>
                <path d="M7 7h.01"/>
            </svg>
        );

        const Trash2 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                <line x1="10" x2="10" y1="11" y2="17"/>
                <line x1="14" x2="14" y1="11" y2="17"/>
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                <path d="M3 21v-5h5"/>
            </svg>
        );

        const Settings = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );

        const OutlookTodoApp = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [accessToken, setAccessToken] = useState(null);
            const [emails, setEmails] = useState([]);
            const [todos, setTodos] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showConfig, setShowConfig] = useState(false);
            const [clientId, setClientId] = useState(localStorage.getItem('outlookClientId') || '');
            const [filter, setFilter] = useState('all');

            const redirectUri = window.location.origin + window.location.pathname;
            const scopes = ['Mail.Read', 'Mail.ReadWrite'];

            const handleLogin = () => {
                if (!clientId) {
                    setError('Inserisci il Client ID prima di continuare');
                    setShowConfig(true);
                    return;
                }

                localStorage.setItem('outlookClientId', clientId);

                const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?` +
                    `client_id=${clientId}` +
                    `&response_type=token` +
                    `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                    `&scope=${encodeURIComponent(scopes.join(' '))}` +
                    `&response_mode=fragment`;
                
                window.location.href = authUrl;
            };

            useEffect(() => {
                const hash = window.location.hash;
                if (hash) {
                    const params = new URLSearchParams(hash.substring(1));
                    const token = params.get('access_token');
                    if (token) {
                        setAccessToken(token);
                        setIsAuthenticated(true);
                        window.location.hash = '';
                    }
                }
            }, []);

            const fetchEmails = async () => {
                if (!accessToken) return;
                
                setLoading(true);
                setError(null);

                try {
                    const twoMonthsAgo = new Date();
                    twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
                    const dateFilter = twoMonthsAgo.toISOString();

                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/messages?` +
                        `$filter=flag/flagStatus eq 'flagged' and receivedDateTime ge ${dateFilter}` +
                        `&$select=subject,from,receivedDateTime,bodyPreview,flag,importance` +
                        `&$orderby=receivedDateTime desc` +
                        `&$top=100`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );

                    if (!response.ok) {
                        throw new Error('Errore nel caricamento delle email');
                    }

                    const data = await response.json();
                    setEmails(data.value);
                    
                    const todoItems = data.value.map(email => ({
                        id: email.id,
                        title: email.subject,
                        sender: email.from.emailAddress.name || email.from.emailAddress.address,
                        date: new Date(email.receivedDateTime).toLocaleDateString('it-IT'),
                        preview: email.bodyPreview.substring(0, 100) + '...',
                        completed: false,
                        importance: email.importance
                    }));
                    
                    setTodos(todoItems);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (isAuthenticated && accessToken) {
                    fetchEmails();
                }
            }, [isAuthenticated, accessToken]);

            const toggleTodo = (id) => {
                setTodos(todos.map(todo => 
                    todo.id === id ? { ...todo, completed: !todo.completed } : todo
                ));
            };

            const deleteTodo = (id) => {
                setTodos(todos.filter(todo => todo.id !== id));
            };

            const filteredTodos = todos.filter(todo => {
                if (filter === 'active') return !todo.completed;
                if (filter === 'completed') return todo.completed;
                return true;
            });

            const stats = {
                total: todos.length,
                completed: todos.filter(t => t.completed).length,
                active: todos.filter(t => !t.completed).length
            };

            if (showConfig) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                        <div className="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Configurazione Azure App</h2>
                            
                            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                                <h3 className="font-bold text-blue-800 mb-2">URL di Redirect per Azure:</h3>
                                <div className="bg-white p-3 rounded border border-blue-200 mb-4">
                                    <code className="text-sm text-blue-900 break-all">{redirectUri}</code>
                                </div>
                                <p className="text-sm text-blue-900 mb-2">Copia questo URL e usalo come "Redirect URI" nella configurazione Azure (tipo: Single-page application)</p>
                            </div>

                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Client ID dell'applicazione Azure
                                </label>
                                <input
                                    type="text"
                                    value={clientId}
                                    onChange={(e) => setClientId(e.target.value)}
                                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <div className="flex gap-4">
                                <button
                                    onClick={() => {
                                        if (clientId) {
                                            localStorage.setItem('outlookClientId', clientId);
                                            setShowConfig(false);
                                        }
                                    }}
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                                >
                                    Salva e Continua
                                </button>
                                <button
                                    onClick={() => setShowConfig(false)}
                                    className="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                                >
                                    Annulla
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <div className="w-16 h-16 mx-auto mb-4 text-blue-600"><Mail /></div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Outlook To-Do Manager</h1>
                                <p className="text-gray-600">Trasforma le tue email contrassegnate in una to-do list organizzata</p>
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                                    {error}
                                </div>
                            )}

                            <button
                                onClick={() => setShowConfig(true)}
                                className="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-200 transition mb-3 flex items-center justify-center gap-2"
                            >
                                <Settings />
                                Configura Client ID
                            </button>

                            <button
                                onClick={handleLogin}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2"
                            >
                                <Mail />
                                Accedi con Microsoft
                            </button>

                            <p className="text-xs text-gray-500 mt-4 text-center">
                                Sono necessari i permessi di lettura delle email per creare la tua to-do list
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                    <div className="max-w-5xl mx-auto">
                        <div className="bg-white rounded-lg shadow-xl overflow-hidden">
                            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h1 className="text-3xl font-bold mb-2">La Tua To-Do List</h1>
                                        <p className="text-blue-100">Email contrassegnate degli ultimi 2 mesi</p>
                                    </div>
                                    <button
                                        onClick={() => setShowConfig(true)}
                                        className="p-2 hover:bg-white/20 rounded-lg transition"
                                    >
                                        <Settings />
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="bg-white/20 rounded-lg p-3 text-center">
                                        <div className="text-2xl font-bold">{stats.total}</div>
                                        <div className="text-sm text-blue-100">Totali</div>
                                    </div>
                                    <div className="bg-white/20 rounded-lg p-3 text-center">
                                        <div className="text-2xl font-bold">{stats.active}</div>
                                        <div className="text-sm text-blue-100">Da fare</div>
                                    </div>
                                    <div className="bg-white/20 rounded-lg p-3 text-center">
                                        <div className="text-2xl font-bold">{stats.completed}</div>
                                        <div className="text-sm text-blue-100">Completati</div>
                                    </div>
                                </div>
                            </div>

                            <div className="p-4 border-b border-gray-200 flex justify-between items-center flex-wrap gap-2">
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setFilter('all')}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            filter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Tutti
                                    </button>
                                    <button
                                        onClick={() => setFilter('active')}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            filter === 'active' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Attivi
                                    </button>
                                    <button
                                        onClick={() => setFilter('completed')}
                                        className={`px-4 py-2 rounded-lg font-medium transition ${
                                            filter === 'completed' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Completati
                                    </button>
                                </div>
                                
                                <button
                                    onClick={fetchEmails}
                                    disabled={loading}
                                    className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50"
                                >
                                    <RefreshCw className={loading ? 'animate-spin' : ''} />
                                    Aggiorna
                                </button>
                            </div>

                            <div className="p-6">
                                {loading ? (
                                    <div className="text-center py-12">
                                        <div className="w-12 h-12 text-blue-600 mx-auto mb-4"><RefreshCw className="animate-spin" /></div>
                                        <p className="text-gray-600">Caricamento email...</p>
                                    </div>
                                ) : error ? (
                                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                                        {error}
                                    </div>
                                ) : filteredTodos.length === 0 ? (
                                    <div className="text-center py-12">
                                        <div className="w-16 h-16 text-green-500 mx-auto mb-4"><CheckCircle2 /></div>
                                        <p className="text-gray-600 text-lg">
                                            {filter === 'completed' ? 'Nessuna attivit√† completata' : 'Nessuna email contrassegnata trovata!'}
                                        </p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {filteredTodos.map(todo => (
                                            <div
                                                key={todo.id}
                                                className={`border rounded-lg p-4 transition hover:shadow-md ${
                                                    todo.completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-300'
                                                }`}
                                            >
                                                <div className="flex items-start gap-3">
                                                    <button
                                                        onClick={() => toggleTodo(todo.id)}
                                                        className="mt-1 flex-shrink-0"
                                                    >
                                                        {todo.completed ? (
                                                            <div className="w-6 h-6 text-green-500"><CheckCircle2 /></div>
                                                        ) : (
                                                            <div className="w-6 h-6 text-gray-400 hover:text-blue-500"><Circle /></div>
                                                        )}
                                                    </button>
                                                    
                                                    <div className="flex-1 min-w-0">
                                                        <h3 className={`font-semibold mb-1 ${todo.completed ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                                                            {todo.title}
                                                        </h3>
                                                        <p className={`text-sm mb-2 ${todo.completed ? 'text-gray-400' : 'text-gray-600'}`}>
                                                            {todo.preview}
                                                        </p>
                                                        <div className="flex items-center gap-4 text-xs text-gray-500 flex-wrap">
                                                            <span className="flex items-center gap-1">
                                                                <div className="w-3 h-3"><Mail /></div>
                                                                {todo.sender}
                                                            </span>
                                                            <span className="flex items-center gap-1">
                                                                <div className="w-3 h-3"><Calendar /></div>
                                                                {todo.date}
                                                            </span>
                                                            {todo.importance === 'high' && (
                                                                <span className="flex items-center gap-1 text-red-600">
                                                                    <div className="w-3 h-3"><Tag /></div>
                                                                    Importante
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    <button
                                                        onClick={() => deleteTodo(todo.id)}
                                                        className="flex-shrink-0 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition"
                                                    >
                                                        <Trash2 />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<OutlookTodoApp />, document.getElementById('root'));
    </script>
</body>
</html>
